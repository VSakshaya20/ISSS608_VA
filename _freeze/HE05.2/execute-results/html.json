{
  "hash": "7aeec8f919d64caa3be38ead9c9d3262",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Hands-on Exercise 5-B\"\nsubtitle: \"Visual Correlation Analysis\"\nauthor: \"Akshaya Vijayakumar Sivakami\"\ndate: \"9 February 2026\"\ndate-modified: \"last-modified\"\nexecute: \n  eval: true\n  echo: true\n  warning: false\n  freeze: true\n---\n\n# Overview\n\n## Understanding the Correlation Coefficient\n\nThe correlation coefficient is a standard metric used to quantify the nature and intensity of the relationship between two variables. These values are bounded between -1.0 and 1.0:\n\n-   1.0: Represents a perfect positive linear relationship.\n\n-   -1.0: Represents a perfect inverse (negative) relationship.\n\n-   0.0: Indicates that no linear relationship exists between the variables.\n\n## The Correlation Matrix\n\nWhen working with multivariate data, these coefficients are typically organized into a table known as a correlation matrix or visualized via a scatterplot matrix.\n\n**Why Use a Correlation Matrix?**\n\n-   Exploratory Analysis: It reveals pairwise relationships within high-dimensional datasets.\n\n-   Model Input: It serves as the foundation for complex statistical techniques, such as Exploratory Factor Analysis (EFA), Structural Equation Modeling (SEM), and linear regressions.\n\n-   Diagnostics: It acts as a health check for other models. For instance, excessively high correlations in a linear regression can signal multicollinearity, making estimates unreliable.\n\n## Visualizing Large Data with Corrgrams\n\nWhen datasets contain a high volume of observations or variables, a Corrgram is often used to detect patterns and structures. It operates on two primary principles:\n\n-   Visual Rendering: Mapping the sign and magnitude of correlations to specific colors or shapes.\n\n-   Variable Reordering: Grouping \"similar\" variables together to make clusters and relationships easier to perceive.\n\nThis hands-on exercise explores visualising correlation matrix with R. It consists of first creating matrices using the pairs() function, generating advanced corrgrams with the corrplot package, then finally building dynamic, interactive correlation matrices using plotly.\n\n# Getting Started\n\n## Installing and Launching R Packages\n\nThe code chunk below is used to install and launch corrplot, ggpubr, plotly and tidyverse in RStudio.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(corrplot, ggstatsplot, tidyverse)\n```\n:::\n\n\n## Importing and Preparing The Data Set\n\nIn this hands-on exercise, the [Wine Quality Data Set](https://archive.ics.uci.edu/ml/datasets/wine+quality) of UCI Machine Learning Repository will be used. The data set consists of 13 variables and 6497 observations. For the purpose of this exercise, the red wine and white wine data has been combined into one data file. It is called wine_quality and is in csv file format.\n\nFirst, the data is imported into R by using read_csv() of readr package.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwine <- read_csv(\"data/wine_quality.csv\")\n```\n:::\n\n\n# Building Correlation Matrix: pairs() method\n\nThere are more than one way to build scatterplot matrix with R. In this section, a scatterplot matrix is created by using the [pairs](https://stat.ethz.ch/R-manual/R-devel/library/graphics/html/pairs.html) function of R Graphics.\n\n## Building a basic correlation matrix\n\nFigure below shows the scatter plot matrix of Wine Quality Data. It is a 11 by 11 matrix.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npairs(wine[,1:11])\n```\n\n::: {.cell-output-display}\n![](HE05.2_files/figure-html/unnamed-chunk-3-1.png){fig-align='center' width=672}\n:::\n:::\n\n\nThe required input of *pairs()* can be a matrix or data frame. The code chunk used to create the scatterplot matrix is relatively simple. It uses the default *pairs* function. Columns 2 to 12 of wine dataframe is used to build the scatterplot matrix. The variables are: *\"fixed acidity\", \"volatile acidity\", \"citric acid\", \"residual sugar\", \"chlorides\", \"free sulfur dioxide\", \"total sulfur dioxide\", \"density\", \"pH\", \"sulphates\"* and *\"alcohol\".*\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npairs(wine[,2:12])\n```\n\n::: {.cell-output-display}\n![](HE05.2_files/figure-html/unnamed-chunk-4-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n## Drawing the lower corner\n\n*pairs* function of R Graphics provided many customisation arguments. For example, it is a common practice to show either the upper half or lower half of the correlation matrix instead of both. This is because a correlation matrix is symmetric.\n\n::: panel-tabset\n### Matrix Lower Half\n\nTo show the lower half of the correlation matrix, the `upper.panel` argument will be used as shown in the code chunk below.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npairs(wine[,2:12], upper.panel = NULL)\n```\n\n::: {.cell-output-display}\n![](HE05.2_files/figure-html/unnamed-chunk-5-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n### Matrix Upper Half\n\nSimilarly, the upper half of the correlation matrix can be displayed by using the `lower.panel` argument.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npairs(wine[,2:12], lower.panel = NULL)\n```\n\n::: {.cell-output-display}\n![](HE05.2_files/figure-html/unnamed-chunk-6-1.png){fig-align='center' width=672}\n:::\n:::\n\n:::\n\n## Including with correlation coefficients\n\nTo show the correlation coefficient of each pair of variables instead of a scatter plot, [panel.cor](https://www.rdocumentation.org/packages/xcms/versions/1.48.0/topics/panel.cor) function will be used. This will also show higher correlations in a larger font.\n\n::: panel-tabset\n### Plot\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](HE05.2_files/figure-html/unnamed-chunk-7-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n### Code\n\n\n::: {.cell}\n\n```{.r .cell-code}\npanel.cor <- function(x, y, digits=2, prefix=\"\", cex.cor, ...) {\nusr <- par(\"usr\")\non.exit(par(usr))\npar(usr = c(0, 1, 0, 1))\nr <- abs(cor(x, y, use=\"complete.obs\"))\ntxt <- format(c(r, 0.123456789), digits=digits)[1]\ntxt <- paste(prefix, txt, sep=\"\")\nif(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)\ntext(0.5, 0.5, txt, cex = cex.cor * (1 + r) / 2)\n}\n\npairs(wine[,2:12], \n      upper.panel = panel.cor)\n```\n:::\n\n:::\n\n# Visualising Correlation Matrix: ggcormat()\n\nOne of the major limitation of the correlation matrix is that the scatter plots appear very cluttered when the number of observations is relatively large (i.e. more than 500 observations). To over come this problem, **Corrgram** data visualisation technique suggested by D. J. Murdoch and E. D. Chow (1996) and Friendly, M (2002) and will be used.\n\nThere are at least three R packages that provide function to plot corrgram, they are:\n\n-   [corrgram](https://cran.r-project.org/web/packages/corrgram/index.html)\n\n-   [ellipse](https://cran.r-project.org/web/packages/ellipse/index.html)\n\n-   [corrplot](https://cran.r-project.org/web/packages/corrplot/index.html)\n\nOn top that, some R packages like ggstatsplot package also provides functions for building corrgram.\n\nThis section illustrates how to visualise correlation matrix by using [*ggcorrmat()*](https://indrajeetpatil.github.io/ggstatsplot/reference/ggcorrmat.html) of [**ggstatsplot**](https://indrajeetpatil.github.io/ggstatsplot/index.html) package.\n\nOn of the advantage of using *ggcorrmat()* over many other methods to visualise a correlation matrix is it’s ability to provide a comprehensive and yet professional statistical report as shown in the figure below.\n\n::: panel-tabset\n### Plot\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](HE05.2_files/figure-html/unnamed-chunk-9-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n### Code\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggstatsplot::ggcorrmat(\n  data = wine, \n  cor.vars = 1:11)\n```\n:::\n\n:::\n\n::: panel-tabset\n### Plot\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](HE05.2_files/figure-html/unnamed-chunk-11-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n### Code\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggstatsplot::ggcorrmat(\n  data = wine, \n  cor.vars = 1:11,\n  ggcorrplot.args = list(outline.color = \"black\", \n                         hc.order = TRUE,\n                         tl.cex = 10),\n  title    = \"Correlogram for wine dataset\",\n  subtitle = \"Four pairs are no significant at p < 0.05\"\n)\n```\n:::\n\n:::\n\n**Things to learn from the code chunk above:**\n\n-   `cor.vars` argument is used to compute the correlation matrix needed to build the corrgram.\n\n-   `ggcorrplot.args` argument provide additional (mostly aesthetic) arguments that will be passed to [`ggcorrplot::ggcorrplot`](http://www.sthda.com/english/wiki/ggcorrplot-visualization-of-a-correlation-matrix-using-ggplot2) function. The list should avoid any of the following arguments since they are already internally being used: `corr`, `method`, `p.mat`, `sig.level`, `ggtheme`, `colors`, `lab`, `pch`, `legend.title`, `digits`.\n\nThe sample sub-code chunk can be used to control specific component of the plot such as the font size of the x-axis, y-axis, and the statistical report.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot.component = list(\n    theme(text=element_text(size=5),\n      axis.text.x = element_text(size = 8),\n      axis.text.y = element_text(size = 8)))\n```\n:::\n\n\n# Building multiple plots\n\nSince ggstasplot is an extension of ggplot2, it also supports faceting. However the feature is not available in *ggcorrmat()* but in the [*grouped_ggcorrmat()*](https://indrajeetpatil.github.io/ggstatsplot/reference/grouped_ggcorrmat.html) of **ggstatsplot**.\n\n::: panel-tabset\n### Plot\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](HE05.2_files/figure-html/unnamed-chunk-14-1.png){fig-align='center' width=1152}\n:::\n:::\n\n\n### Code\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngrouped_ggcorrmat(\n  data = wine,\n  cor.vars = 1:11,\n  grouping.var = type,\n  type = \"robust\",\n  p.adjust.method = \"holm\",\n  plotgrid.args = list(ncol = 2),\n  ggcorrplot.args = list(outline.color = \"black\", \n                         hc.order = TRUE,\n                         tl.cex = 10),\n  annotation.args = list(\n    tag_levels = \"a\",\n    title = \"Correlogram for wine dataset\",\n    subtitle = \"The measures are: alcohol, sulphates, fixed acidity, citric acid, chlorides, residual sugar, density, free sulfur dioxide and volatile acidity\",\n    caption = \"Dataset: UCI Machine Learning Repository\"\n  )\n)\n```\n:::\n\n:::\n\n**Things to learn from the code chunk above:**\n\n-   To build a facet plot, the only argument needed is `grouping.var`.\n\n-   Behind *group_ggcorrmat()*, **patchwork** package is used to create the multiplot. `plotgrid.args` argument provides a list of additional arguments passed to [*patchwork::wrap_plots*](https://patchwork.data-imaginist.com/reference/wrap_plots.html), except for guides argument which is already separately specified earlier.\n\n-   Likewise, `annotation.args` argument is calling [*plot annotation arguments*](https://patchwork.data-imaginist.com/reference/plot_annotation.html) of patchwork package.\n\n# Visualising Correlation Matrix using corrplot Package\n\nThis section focuses on corrplot. In order to gain basic understanding of **corrplot** package, it is recommended to read [An Introduction to corrplot Package](https://cran.r-project.org/web/packages/corrplot/vignettes/corrplot-intro.html).\n\n## Getting started with corrplot\n\nBefore plotting a corrgram using *corrplot()*, the correlation matrix of wine data frame should be computed.\n\nIn the code chunk below, [*cor()*](https://www.rdocumentation.org/packages/stats/versions/3.6.0/topics/cor) of R Stats is used to compute the correlation matrix of wine data frame.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwine.cor <- cor(wine[, 1:11])\n```\n:::\n\n\nNext, [*corrplot()*](https://www.rdocumentation.org/packages/corrplot/versions/0.2-0/topics/corrplot) is used to plot the corrgram by using all the default setting as shown in the code chunk below.\n\n::: panel-tabset\n### Plot\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](HE05.2_files/figure-html/unnamed-chunk-17-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n### Code\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncorrplot(wine.cor)\n```\n:::\n\n:::\n\nBy default, the corrgram displays as a symmetric matrix using **circles** as the primary visual element. It utilizes a **blue-red** diverging color scheme to illustrate the relationship between variables:\n\n-   **Hue (Direction):** **Blue** represents a positive correlation, while **red** indicates a negative correlation.\n\n-   **Saturation (Strength):** The intensity of the color reflects the correlation's magnitude. **Darker, more saturated tones** signify a strong linear relationship, whereas **lighter, desaturated tones** point to a weaker one.\n\n## Working with visual geometrics\n\nThe `corrplot` package offers seven visual geometries (via the `method` parameter) to encode correlation values: **circle**, **square**, **ellipse**, **number**, **shade**, **color**, and **pie**.\n\nWhile the package defaults to the **circle** geometric, you can easily customize this by applying the `method` argument. The following code chunk demonstrates how to override the default and select an alternative visualization style.\n\n::: panel-tabset\n### Plot\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](HE05.2_files/figure-html/unnamed-chunk-19-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n### Code\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncorrplot(wine.cor, \n         method = \"ellipse\") \n```\n:::\n\n:::\n\n## Working with layout\n\nThe `corrplot()` function supports three distinct layout types:\n\n-   **\"full\" (Default):** Displays the entire symmetric matrix.\n\n-   **\"upper\":** Displays only the upper triangular portion of the matrix.\n\n-   **\"lower\":** Displays only the lower triangular portion of the matrix.\n\nThis layout can be modified by adjusting the `type` argument within the function.\n\n::: panel-tabset\n### Plot\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](HE05.2_files/figure-html/unnamed-chunk-21-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n### Code\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncorrplot(wine.cor, \n         method = \"ellipse\", \n         type=\"lower\")\n```\n:::\n\n:::\n\nThe default corrgram layout can be further refined using additional arguments. For instance, the `diag` parameter allows hiding the diagonal cells, while `tl.col` can be used to set the axis text labels to black. These customizations are illustrated in the code chunk and resulting figure below.\n\n::: panel-tabset\n### Plot\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](HE05.2_files/figure-html/unnamed-chunk-23-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n### Code\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncorrplot(wine.cor, \n         method = \"ellipse\", \n         type=\"lower\",\n         diag = FALSE,\n         tl.col = \"black\")\n```\n:::\n\n:::\n\n## Working with mixed layout\n\nWith **corrplot** package, it is possible to design corrgram with mixed visual matrix of one half and numerical matrix on the other half. In order to create a coorgram with mixed layout, the [*corrplot.mixed()*](https://www.rdocumentation.org/packages/corrplot/versions/0.84/topics/corrplot.mixed), a wrapped function for mixed visualisation style will be used.\n\nFigure below shows a mixed layout corrgram plotted using wine quality data.\n\n::: panel-tabset\n### Plot\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](HE05.2_files/figure-html/unnamed-chunk-25-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n### Code\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncorrplot.mixed(wine.cor, \n               lower = \"ellipse\", \n               upper = \"number\",\n               tl.pos = \"lt\",\n               diag = \"l\",\n               tl.col = \"black\")\n```\n:::\n\n:::\n\nThe `lower` and `upper` arguments permits different visualization methods to each half of the matrix. In this example, an **ellipse** method is assigned to the lower half, while a **numerical matrix** (number) is used for the upper half.\n\nTo manage the layout further:\n\n-   **`tl.pos`**: Determines the placement and orientation of the axis labels.\n\n-   **`diag`**: Specifies the type of glyph or value displayed along the principal diagonal.\n\n## Combining corrgram with the significant test\n\nIn statistical analysis, it is often crucial to identify which correlation coefficients are **statistically significant** rather than relying solely on their magnitude.\n\nThe figure below integrates a significance test into the corrgram. This visualization reveals that several variable pairings lack statistical significance. For instance, while the correlation between total sulfur dioxide and free sulfur dioxide is significant at the p \\< 0.1 level, the relationship between total sulfurdioxide and citric acid fails to meet this threshold.\n\nWith corrplot package, we can use the *cor.mtest()* to compute the p-values and confidence interval for each pair of variables.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwine.sig = cor.mtest(wine.cor, conf.level= .95)\n```\n:::\n\n\nThe *p.mat* argument of *corrplot* function can then be used as shown in the code chunk below.\n\n::: panel-tabset\n### Plot\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](HE05.2_files/figure-html/unnamed-chunk-28-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n### Code\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncorrplot(wine.cor,\n         method = \"number\",\n         type = \"lower\",\n         diag = FALSE,\n         tl.col = \"black\",\n         tl.srt = 45,\n         p.mat = wine.sig$p,\n         sig.level = .05)\n```\n:::\n\n:::\n\n## Reorder a corrgram\n\nReordering the matrix is essential for uncovering hidden structures and patterns within a corrgram. By default, the attributes are displayed in their original order as provided in the dataset. However, this can be overwritten using the `order` argument.\n\nThe `corrplot` package supports four primary sorting methods:\n\n-   **\"AOE\" (Angular Order of Eigenvectors):** Based on the eigenvector angles; provides a smooth ordering of variables.\n\n-   **\"FPC\" (First Principal Component):** Orders variables based on their loading on the first principal component.\n\n-   **\"hclust\" (Hierarchical Clustering):** Groups similar variables together. When using this, you can specify an agglomeration method (e.g., \"ward\", \"average\", \"complete\") via the `hclust.method` argument.\n\n-   **\"alphabet\":** Arranges variables in simple alphabetical order.\n\nFor even more advanced sorting algorithms, the `seriation` package can be used in conjunction with `corrplot`.\n\n::: panel-tabset\n### Plot\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](HE05.2_files/figure-html/unnamed-chunk-30-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n### Code\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncorrplot.mixed(wine.cor, \n               lower = \"ellipse\", \n               upper = \"number\",\n               tl.pos = \"lt\",\n               diag = \"l\",\n               order=\"AOE\",\n               tl.col = \"black\")\n```\n:::\n\n:::\n\n## Reordering a correlation matrix using hclust\n\nBy using **hclust**, ***corrplot()*** can draw rectangles around the corrgram based on the results of hierarchical clustering.\n\n::: panel-tabset\n### Plot\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](HE05.2_files/figure-html/unnamed-chunk-32-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n### Code\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncorrplot(wine.cor, \n         method = \"ellipse\", \n         tl.pos = \"lt\",\n         tl.col = \"black\",\n         order=\"hclust\",\n         hclust.method = \"ward.D\",\n         addrect = 3)\n```\n:::\n\n:::\n\n# References\n\n-   Kam, T.S. (2023). [Visual Correlation Analysis](https://r4va.netlify.app/chap06)\n\n-   Michael Friendly (2002). “Corrgrams: Exploratory displays for correlation matrices”. *The American Statistician*, 56, 316–324.\n\n-   D.J. Murdoch, E.D. Chow (1996). “A graphical display of large correlation matrices”. *The American Statistician*, 50, 178–180.\n\n-   [`ggcormat()`](https://indrajeetpatil.github.io/ggstatsplot/articles/web_only/ggcorrmat.html) of [**ggstatsplot**](https://indrajeetpatil.github.io/ggstatsplot/index.html) package\n\n-   [`ggscatmat`](https://ggobi.github.io/ggally/reference/ggscatmat.html) and [`ggpairs`](https://ggobi.github.io/ggally/reference/ggpairs.html) of [**GGally**](https://ggobi.github.io/ggally/index.html).\n\n-   [**corrplot**](https://cran.r-project.org/web/packages/corrplot/index.html). A graphical display of a correlation matrix or general matrix. It also contains some algorithms to do matrix reordering. In addition, corrplot is good at details, including choosing color, text labels, color labels, layout, etc.\n\n-   [**corrgram**](https://cran.r-project.org/web/packages/corrgram/index.html) calculates correlation of variables and displays the results graphically. Included panel functions can display points, shading, ellipses, and correlation values with confidence intervals.\n",
    "supporting": [
      "HE05.2_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
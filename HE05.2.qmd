---
title: "Hands-on Exercise 5-B"
subtitle: "Visual Correlation Analysis"
author: "Akshaya Vijayakumar Sivakami"
date: "9 February 2026"
date-modified: "last-modified"
execute: 
  eval: true
  echo: true
  warning: false
  freeze: true
---

# Overview

## Understanding the Correlation Coefficient

The correlation coefficient is a standard metric used to quantify the nature and intensity of the relationship between two variables. These values are bounded between -1.0 and 1.0:

-   1.0: Represents a perfect positive linear relationship.

-   -1.0: Represents a perfect inverse (negative) relationship.

-   0.0: Indicates that no linear relationship exists between the variables.

## The Correlation Matrix

When working with multivariate data, these coefficients are typically organized into a table known as a correlation matrix or visualized via a scatterplot matrix.

**Why Use a Correlation Matrix?**

-   Exploratory Analysis: It reveals pairwise relationships within high-dimensional datasets.

-   Model Input: It serves as the foundation for complex statistical techniques, such as Exploratory Factor Analysis (EFA), Structural Equation Modeling (SEM), and linear regressions.

-   Diagnostics: It acts as a health check for other models. For instance, excessively high correlations in a linear regression can signal multicollinearity, making estimates unreliable.

## Visualizing Large Data with Corrgrams

When datasets contain a high volume of observations or variables, a Corrgram is often used to detect patterns and structures. It operates on two primary principles:

-   Visual Rendering: Mapping the sign and magnitude of correlations to specific colors or shapes.

-   Variable Reordering: Grouping "similar" variables together to make clusters and relationships easier to perceive.

This hands-on exercise explores visualising correlation matrix with R. It consists of first creating matrices using the pairs() function, generating advanced corrgrams with the corrplot package, then finally building dynamic, interactive correlation matrices using plotly.

# Getting Started

## Installing and Launching R Packages

The code chunk below is used to install and launch corrplot, ggpubr, plotly and tidyverse in RStudio.

```{r}
pacman::p_load(corrplot, ggstatsplot, tidyverse)
```

## Importing and Preparing The Data Set

In this hands-on exercise, the [Wine Quality Data Set](https://archive.ics.uci.edu/ml/datasets/wine+quality) of UCI Machine Learning Repository will be used. The data set consists of 13 variables and 6497 observations. For the purpose of this exercise, the red wine and white wine data has been combined into one data file. It is called wine_quality and is in csv file format.

First, the data is imported into R by using read_csv() of readr package.

```{r}
wine <- read_csv("data/wine_quality.csv")
```

# Building Correlation Matrix: pairs() method

There are more than one way to build scatterplot matrix with R. In this section, a scatterplot matrix is created by using the [pairs](https://stat.ethz.ch/R-manual/R-devel/library/graphics/html/pairs.html) function of R Graphics.

## Building a basic correlation matrix

Figure below shows the scatter plot matrix of Wine Quality Data. It is a 11 by 11 matrix.

```{r}
#| fig-align: "center"
pairs(wine[,1:11])
```

The required input of *pairs()* can be a matrix or data frame. The code chunk used to create the scatterplot matrix is relatively simple. It uses the default *pairs* function. Columns 2 to 12 of wine dataframe is used to build the scatterplot matrix. The variables are: *"fixed acidity", "volatile acidity", "citric acid", "residual sugar", "chlorides", "free sulfur dioxide", "total sulfur dioxide", "density", "pH", "sulphates"* and *"alcohol".*

```{r}
#| fig-align: "center"
pairs(wine[,2:12])
```

## Drawing the lower corner

*pairs* function of R Graphics provided many customisation arguments. For example, it is a common practice to show either the upper half or lower half of the correlation matrix instead of both. This is because a correlation matrix is symmetric.

::: panel-tabset
### Matrix Lower Half

To show the lower half of the correlation matrix, the `upper.panel` argument will be used as shown in the code chunk below.

```{r}
#| fig-align: "center"
pairs(wine[,2:12], upper.panel = NULL)
```

### Matrix Upper Half

Similarly, the upper half of the correlation matrix can be displayed by using the `lower.panel` argument.

```{r}
#| fig-align: "center"
pairs(wine[,2:12], lower.panel = NULL)
```
:::

## Including with correlation coefficients

To show the correlation coefficient of each pair of variables instead of a scatter plot, [panel.cor](https://www.rdocumentation.org/packages/xcms/versions/1.48.0/topics/panel.cor) function will be used. This will also show higher correlations in a larger font.

::: panel-tabset
### Plot

```{r}
#| echo: false
#| eval: true
#| fig-align: "center"
panel.cor <- function(x, y, digits=2, prefix="", cex.cor, ...) {
usr <- par("usr")
on.exit(par(usr))
par(usr = c(0, 1, 0, 1))
r <- abs(cor(x, y, use="complete.obs"))
txt <- format(c(r, 0.123456789), digits=digits)[1]
txt <- paste(prefix, txt, sep="")
if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
text(0.5, 0.5, txt, cex = cex.cor * (1 + r) / 2)
}

pairs(wine[,2:12], 
      upper.panel = panel.cor)
```

### Code

```{r}
#| echo: true
#| eval: false
panel.cor <- function(x, y, digits=2, prefix="", cex.cor, ...) {
usr <- par("usr")
on.exit(par(usr))
par(usr = c(0, 1, 0, 1))
r <- abs(cor(x, y, use="complete.obs"))
txt <- format(c(r, 0.123456789), digits=digits)[1]
txt <- paste(prefix, txt, sep="")
if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
text(0.5, 0.5, txt, cex = cex.cor * (1 + r) / 2)
}

pairs(wine[,2:12], 
      upper.panel = panel.cor)
```
:::

# Visualising Correlation Matrix: ggcormat()

One of the major limitation of the correlation matrix is that the scatter plots appear very cluttered when the number of observations is relatively large (i.e. more than 500 observations). To over come this problem, **Corrgram** data visualisation technique suggested by D. J. Murdoch and E. D. Chow (1996) and Friendly, M (2002) and will be used.

There are at least three R packages that provide function to plot corrgram, they are:

-   [corrgram](https://cran.r-project.org/web/packages/corrgram/index.html)

-   [ellipse](https://cran.r-project.org/web/packages/ellipse/index.html)

-   [corrplot](https://cran.r-project.org/web/packages/corrplot/index.html)

On top that, some R packages like ggstatsplot package also provides functions for building corrgram.

This section illustrates how to visualise correlation matrix by using [*ggcorrmat()*](https://indrajeetpatil.github.io/ggstatsplot/reference/ggcorrmat.html) of [**ggstatsplot**](https://indrajeetpatil.github.io/ggstatsplot/index.html) package.

On of the advantage of using *ggcorrmat()* over many other methods to visualise a correlation matrix is it’s ability to provide a comprehensive and yet professional statistical report as shown in the figure below.

::: panel-tabset
### Plot

```{r}
#| echo: false
#| eval: true
#| fig-align: "center"
ggstatsplot::ggcorrmat(
  data = wine, 
  cor.vars = 1:11)
```

### Code

```{r}
#| echo: true
#| eval: false
ggstatsplot::ggcorrmat(
  data = wine, 
  cor.vars = 1:11)
```
:::

::: panel-tabset
### Plot

```{r}
#| echo: false
#| eval: true
#| fig-align: "center"
ggstatsplot::ggcorrmat(
  data = wine, 
  cor.vars = 1:11,
  ggcorrplot.args = list(outline.color = "black", 
                         hc.order = TRUE,
                         tl.cex = 10),
  title    = "Correlogram for wine dataset",
  subtitle = "Four pairs are no significant at p < 0.05"
)
```

### Code

```{r}
#| echo: true
#| eval: false
ggstatsplot::ggcorrmat(
  data = wine, 
  cor.vars = 1:11,
  ggcorrplot.args = list(outline.color = "black", 
                         hc.order = TRUE,
                         tl.cex = 10),
  title    = "Correlogram for wine dataset",
  subtitle = "Four pairs are no significant at p < 0.05"
)
```
:::

**Things to learn from the code chunk above:**

-   `cor.vars` argument is used to compute the correlation matrix needed to build the corrgram.

-   `ggcorrplot.args` argument provide additional (mostly aesthetic) arguments that will be passed to [`ggcorrplot::ggcorrplot`](http://www.sthda.com/english/wiki/ggcorrplot-visualization-of-a-correlation-matrix-using-ggplot2) function. The list should avoid any of the following arguments since they are already internally being used: `corr`, `method`, `p.mat`, `sig.level`, `ggtheme`, `colors`, `lab`, `pch`, `legend.title`, `digits`.

The sample sub-code chunk can be used to control specific component of the plot such as the font size of the x-axis, y-axis, and the statistical report.

```{r}
ggplot.component = list(
    theme(text=element_text(size=5),
      axis.text.x = element_text(size = 8),
      axis.text.y = element_text(size = 8)))
```

# Building multiple plots

Since ggstasplot is an extension of ggplot2, it also supports faceting. However the feature is not available in *ggcorrmat()* but in the [*grouped_ggcorrmat()*](https://indrajeetpatil.github.io/ggstatsplot/reference/grouped_ggcorrmat.html) of **ggstatsplot**.

::: panel-tabset
### Plot

```{r}
#| echo: false
#| eval: true
#| fig-align: "center"
#| fig.width: 12
#| fig.height: 8
grouped_ggcorrmat(
  data = wine,
  cor.vars = 1:11,
  grouping.var = type,
  type = "robust",
  p.adjust.method = "holm",
  plotgrid.args = list(ncol = 2),
  ggcorrplot.args = list(outline.color = "black", 
                         hc.order = TRUE,
                         tl.cex = 10),
  annotation.args = list(
    tag_levels = "a",
    title = "Correlogram for wine dataset",
    subtitle = "The measures are: alcohol, sulphates, fixed acidity, citric acid, chlorides, residual sugar, density, free sulfur dioxide and volatile acidity",
    caption = "Dataset: UCI Machine Learning Repository"
  )
)
```

### Code

```{r}
#| echo: true
#| eval: false
grouped_ggcorrmat(
  data = wine,
  cor.vars = 1:11,
  grouping.var = type,
  type = "robust",
  p.adjust.method = "holm",
  plotgrid.args = list(ncol = 2),
  ggcorrplot.args = list(outline.color = "black", 
                         hc.order = TRUE,
                         tl.cex = 10),
  annotation.args = list(
    tag_levels = "a",
    title = "Correlogram for wine dataset",
    subtitle = "The measures are: alcohol, sulphates, fixed acidity, citric acid, chlorides, residual sugar, density, free sulfur dioxide and volatile acidity",
    caption = "Dataset: UCI Machine Learning Repository"
  )
)
```
:::

**Things to learn from the code chunk above:**

-   To build a facet plot, the only argument needed is `grouping.var`.

-   Behind *group_ggcorrmat()*, **patchwork** package is used to create the multiplot. `plotgrid.args` argument provides a list of additional arguments passed to [*patchwork::wrap_plots*](https://patchwork.data-imaginist.com/reference/wrap_plots.html), except for guides argument which is already separately specified earlier.

-   Likewise, `annotation.args` argument is calling [*plot annotation arguments*](https://patchwork.data-imaginist.com/reference/plot_annotation.html) of patchwork package.

# Visualising Correlation Matrix using corrplot Package

This section focuses on corrplot. In order to gain basic understanding of **corrplot** package, it is recommended to read [An Introduction to corrplot Package](https://cran.r-project.org/web/packages/corrplot/vignettes/corrplot-intro.html).

## Getting started with corrplot

Before plotting a corrgram using *corrplot()*, the correlation matrix of wine data frame should be computed.

In the code chunk below, [*cor()*](https://www.rdocumentation.org/packages/stats/versions/3.6.0/topics/cor) of R Stats is used to compute the correlation matrix of wine data frame.

```{r}
wine.cor <- cor(wine[, 1:11])
```

Next, [*corrplot()*](https://www.rdocumentation.org/packages/corrplot/versions/0.2-0/topics/corrplot) is used to plot the corrgram by using all the default setting as shown in the code chunk below.

::: panel-tabset
### Plot

```{r}
#| echo: false
#| eval: true
#| fig-align: "center"
corrplot(wine.cor)
```

### Code

```{r}
#| echo: true
#| eval: false
corrplot(wine.cor)
```
:::

By default, the corrgram displays as a symmetric matrix using **circles** as the primary visual element. It utilizes a **blue-red** diverging color scheme to illustrate the relationship between variables:

-   **Hue (Direction):** **Blue** represents a positive correlation, while **red** indicates a negative correlation.

-   **Saturation (Strength):** The intensity of the color reflects the correlation's magnitude. **Darker, more saturated tones** signify a strong linear relationship, whereas **lighter, desaturated tones** point to a weaker one.

## Working with visual geometrics

The `corrplot` package offers seven visual geometries (via the `method` parameter) to encode correlation values: **circle**, **square**, **ellipse**, **number**, **shade**, **color**, and **pie**.

While the package defaults to the **circle** geometric, you can easily customize this by applying the `method` argument. The following code chunk demonstrates how to override the default and select an alternative visualization style.

::: panel-tabset
### Plot

```{r}
#| echo: false
#| eval: true
#| fig-align: "center"
corrplot(wine.cor, 
         method = "ellipse") 
```

### Code

```{r}
#| echo: true
#| eval: false
corrplot(wine.cor, 
         method = "ellipse") 
```
:::

## Working with layout

The `corrplot()` function supports three distinct layout types:

-   **"full" (Default):** Displays the entire symmetric matrix.

-   **"upper":** Displays only the upper triangular portion of the matrix.

-   **"lower":** Displays only the lower triangular portion of the matrix.

This layout can be modified by adjusting the `type` argument within the function.

::: panel-tabset
### Plot

```{r}
#| echo: false
#| eval: true
#| fig-align: "center"
corrplot(wine.cor, 
         method = "ellipse", 
         type="lower")
```

### Code

```{r}
#| echo: true
#| eval: false
corrplot(wine.cor, 
         method = "ellipse", 
         type="lower")
```
:::

The default corrgram layout can be further refined using additional arguments. For instance, the `diag` parameter allows hiding the diagonal cells, while `tl.col` can be used to set the axis text labels to black. These customizations are illustrated in the code chunk and resulting figure below.

::: panel-tabset
### Plot

```{r}
#| echo: false
#| eval: true
#| fig-align: "center"
corrplot(wine.cor, 
         method = "ellipse", 
         type="lower",
         diag = FALSE,
         tl.col = "black")
```

### Code

```{r}
#| echo: true
#| eval: false
corrplot(wine.cor, 
         method = "ellipse", 
         type="lower",
         diag = FALSE,
         tl.col = "black")
```
:::

## Working with mixed layout

With **corrplot** package, it is possible to design corrgram with mixed visual matrix of one half and numerical matrix on the other half. In order to create a coorgram with mixed layout, the [*corrplot.mixed()*](https://www.rdocumentation.org/packages/corrplot/versions/0.84/topics/corrplot.mixed), a wrapped function for mixed visualisation style will be used.

Figure below shows a mixed layout corrgram plotted using wine quality data.

::: panel-tabset
### Plot

```{r}
#| echo: false
#| eval: true
#| fig-align: "center"
corrplot.mixed(wine.cor, 
               lower = "ellipse", 
               upper = "number",
               tl.pos = "lt",
               diag = "l",
               tl.col = "black")
```

### Code

```{r}
#| echo: true
#| eval: false
corrplot.mixed(wine.cor, 
               lower = "ellipse", 
               upper = "number",
               tl.pos = "lt",
               diag = "l",
               tl.col = "black")
```
:::

The `lower` and `upper` arguments permits different visualization methods to each half of the matrix. In this example, an **ellipse** method is assigned to the lower half, while a **numerical matrix** (number) is used for the upper half.

To manage the layout further:

-   **`tl.pos`**: Determines the placement and orientation of the axis labels.

-   **`diag`**: Specifies the type of glyph or value displayed along the principal diagonal.

## Combining corrgram with the significant test

In statistical analysis, it is often crucial to identify which correlation coefficients are **statistically significant** rather than relying solely on their magnitude.

The figure below integrates a significance test into the corrgram. This visualization reveals that several variable pairings lack statistical significance. For instance, while the correlation between total sulfur dioxide and free sulfur dioxide is significant at the p \< 0.1 level, the relationship between total sulfurdioxide and citric acid fails to meet this threshold.

With corrplot package, we can use the *cor.mtest()* to compute the p-values and confidence interval for each pair of variables.

```{r}
wine.sig = cor.mtest(wine.cor, conf.level= .95)
```

The *p.mat* argument of *corrplot* function can then be used as shown in the code chunk below.

::: panel-tabset
### Plot

```{r}
#| echo: false
#| eval: true
#| fig-align: "center"
corrplot(wine.cor,
         method = "number",
         type = "lower",
         diag = FALSE,
         tl.col = "black",
         tl.srt = 45,
         p.mat = wine.sig$p,
         sig.level = .05)
```

### Code

```{r}
#| echo: true
#| eval: false
corrplot(wine.cor,
         method = "number",
         type = "lower",
         diag = FALSE,
         tl.col = "black",
         tl.srt = 45,
         p.mat = wine.sig$p,
         sig.level = .05)
```
:::

## Reorder a corrgram

Reordering the matrix is essential for uncovering hidden structures and patterns within a corrgram. By default, the attributes are displayed in their original order as provided in the dataset. However, this can be overwritten using the `order` argument.

The `corrplot` package supports four primary sorting methods:

-   **"AOE" (Angular Order of Eigenvectors):** Based on the eigenvector angles; provides a smooth ordering of variables.

-   **"FPC" (First Principal Component):** Orders variables based on their loading on the first principal component.

-   **"hclust" (Hierarchical Clustering):** Groups similar variables together. When using this, you can specify an agglomeration method (e.g., "ward", "average", "complete") via the `hclust.method` argument.

-   **"alphabet":** Arranges variables in simple alphabetical order.

For even more advanced sorting algorithms, the `seriation` package can be used in conjunction with `corrplot`.

::: panel-tabset
### Plot

```{r}
#| echo: false
#| eval: true
#| fig-align: "center"
corrplot.mixed(wine.cor, 
               lower = "ellipse", 
               upper = "number",
               tl.pos = "lt",
               diag = "l",
               order="AOE",
               tl.col = "black")
```

### Code

```{r}
#| echo: true
#| eval: false
corrplot.mixed(wine.cor, 
               lower = "ellipse", 
               upper = "number",
               tl.pos = "lt",
               diag = "l",
               order="AOE",
               tl.col = "black")
```
:::

## Reordering a correlation matrix using hclust

By using **hclust**, ***corrplot()*** can draw rectangles around the corrgram based on the results of hierarchical clustering.

::: panel-tabset
### Plot

```{r}
#| echo: false
#| eval: true
#| fig-align: "center"
corrplot(wine.cor, 
         method = "ellipse", 
         tl.pos = "lt",
         tl.col = "black",
         order="hclust",
         hclust.method = "ward.D",
         addrect = 3)
```

### Code

```{r}
#| echo: true
#| eval: false
corrplot(wine.cor, 
         method = "ellipse", 
         tl.pos = "lt",
         tl.col = "black",
         order="hclust",
         hclust.method = "ward.D",
         addrect = 3)
```
:::

# References

-   Kam, T.S. (2023). [Visual Correlation Analysis](https://r4va.netlify.app/chap06)

-   Michael Friendly (2002). “Corrgrams: Exploratory displays for correlation matrices”. *The American Statistician*, 56, 316–324.

-   D.J. Murdoch, E.D. Chow (1996). “A graphical display of large correlation matrices”. *The American Statistician*, 50, 178–180.

-   [`ggcormat()`](https://indrajeetpatil.github.io/ggstatsplot/articles/web_only/ggcorrmat.html) of [**ggstatsplot**](https://indrajeetpatil.github.io/ggstatsplot/index.html) package

-   [`ggscatmat`](https://ggobi.github.io/ggally/reference/ggscatmat.html) and [`ggpairs`](https://ggobi.github.io/ggally/reference/ggpairs.html) of [**GGally**](https://ggobi.github.io/ggally/index.html).

-   [**corrplot**](https://cran.r-project.org/web/packages/corrplot/index.html). A graphical display of a correlation matrix or general matrix. It also contains some algorithms to do matrix reordering. In addition, corrplot is good at details, including choosing color, text labels, color labels, layout, etc.

-   [**corrgram**](https://cran.r-project.org/web/packages/corrgram/index.html) calculates correlation of variables and displays the results graphically. Included panel functions can display points, shading, ellipses, and correlation values with confidence intervals.
